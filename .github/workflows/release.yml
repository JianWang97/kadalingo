name: Release

on:
  push:
    branches:
      - main  # å½“æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶æ£€æŸ¥ç‰ˆæœ¬
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string

jobs:
  release:
    runs-on: windows-latest  # ä½¿ç”¨ Windows ç¯å¢ƒæ„å»º exe æ–‡ä»¶
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release
      actions: read    # è¯»å–actionsæƒé™
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²è®°å½•
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Check package.json version
        id: check_version
        shell: pwsh
        run: |
          # è¯»å– package.json ä¸­çš„ç‰ˆæœ¬å·
          $packageJson = Get-Content -Path "package.json" -Raw | ConvertFrom-Json
          $currentVersion = $packageJson.version
          $tagName = "v$currentVersion"
          
          echo "Current package.json version: $currentVersion"
          echo "Tag name: $tagName"
          
          # æ£€æŸ¥è¯¥ç‰ˆæœ¬çš„ tag æ˜¯å¦å·²ç»å­˜åœ¨
          $tagExists = $false
          try {
            git rev-parse --verify "refs/tags/$tagName" 2>$null
            if ($LASTEXITCODE -eq 0) {
              $tagExists = $true
            }
          } catch {
            $tagExists = $false
          }
          
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™å…è®¸ç»§ç»­
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            echo "Manual trigger - proceeding with release"
            echo "should_release=true" >> $env:GITHUB_OUTPUT
          } elseif ($tagExists) {
            echo "Tag $tagName already exists - skipping release"
            echo "should_release=false" >> $env:GITHUB_OUTPUT
          } else {
            echo "New version detected - proceeding with release"
            echo "should_release=true" >> $env:GITHUB_OUTPUT
          }
          
          echo "current_version=$currentVersion" >> $env:GITHUB_OUTPUT
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          echo "tag_exists=$tagExists" >> $env:GITHUB_OUTPUT
      
      - name: Install dependencies
        if: steps.check_version.outputs.should_release == 'true'
        run: npm ci
        
      - name: Build application
        if: steps.check_version.outputs.should_release == 'true'
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: List build output (debug)
        if: steps.check_version.outputs.should_release == 'true'
        run: dir build
        
      - name: Extract version from tag or input
        if: steps.check_version.outputs.should_release == 'true'
        id: get_version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}" -replace '^v', ''
            $tag_name = "${{ github.event.inputs.version }}"
            echo "version=$version" >> $env:GITHUB_OUTPUT
            echo "tag_name=$tag_name" >> $env:GITHUB_OUTPUT
            echo "Manual trigger with version: $tag_name"
          } else {
            # ä½¿ç”¨ä» package.json è¯»å–çš„ç‰ˆæœ¬
            $version = "${{ steps.check_version.outputs.current_version }}"
            $tag_name = "${{ steps.check_version.outputs.tag_name }}"
            echo "version=$version" >> $env:GITHUB_OUTPUT
            echo "tag_name=$tag_name" >> $env:GITHUB_OUTPUT
            echo "Package.json version: $tag_name"
          }
      - name: Create tag for manual trigger
        if: github.event_name == 'workflow_dispatch' && steps.check_version.outputs.should_release == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${{ steps.get_version.outputs.tag_name }}
          git push origin ${{ steps.get_version.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create tag for package version update
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check_version.outputs.should_release == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${{ steps.check_version.outputs.tag_name }}
          git push origin ${{ steps.check_version.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Release
        if: steps.check_version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag_name }}
          name: å’”å“’ ${{ steps.get_version.outputs.tag_name }} - è¯­è¨€å­¦ä¹ å¥å­ç»ƒä¹ å·¥å…·
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          body: |
            ğŸš€ **å’”å“’è¯­è¨€å­¦ä¹ å·¥å…·** ${{ steps.get_version.outputs.tag_name }} ç‰ˆæœ¬å‘å¸ƒ
            
            ## ğŸ“¥ ä¸‹è½½è¯´æ˜
            - **`kadalingo-${{ steps.get_version.outputs.version }}-Setup.exe`**: å®Œæ•´å®‰è£…åŒ…ï¼Œæ¨èå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨
            - **`kadalingo ${{ steps.get_version.outputs.version }}.exe`**: ä¾¿æºç‰ˆï¼Œæ— éœ€å®‰è£…ç›´æ¥è¿è¡Œ
            
            ## âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸ¯ è¯­è¨€å­¦ä¹ å¥å­ç»ƒä¹ åŠŸèƒ½
            - ğŸŒ æ”¯æŒå¤šè¯­è¨€ç•Œé¢
            - ğŸ¨ ç°ä»£åŒ–çš„ç”¨æˆ·ç•Œé¢è®¾è®¡
            - ğŸ“± å“åº”å¼è®¾è®¡ï¼Œé€‚é…ä¸åŒå±å¹•å°ºå¯¸
            - ğŸ“ AI ç”Ÿæˆè¯¾ç¨‹å†…å®¹ï¼ŒåŠ©åŠ›é«˜æ•ˆå­¦ä¹ 
            
            ## ğŸ”§ å®‰è£…è¯´æ˜
            1. ä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…
            2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®‰è£…
            3. å¯åŠ¨åº”ç”¨å¼€å§‹è¯­è¨€å­¦ä¹ ä¹‹æ—…

            å¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—® [é¡¹ç›®ä¸»é¡µ](https://github.com/JianWang97/kadalingo) æˆ–æäº¤ [Issue](https://github.com/JianWang97/kadalingo/issues)ã€‚
          files: build/*.exe
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload build artifacts (for debugging)
        uses: actions/upload-artifact@v4
        if: failure() && steps.check_version.outputs.should_release == 'true'  # åªåœ¨å¤±è´¥æ—¶ä¸Šä¼ ï¼Œç”¨äºè°ƒè¯•
        with:
          name: build-artifacts
          path: build/
          retention-days: 7

      - name: Install AWS CLI
        if: success() && steps.check_version.outputs.should_release == 'true'
        run: |
          Invoke-WebRequest -Uri "https://awscli.amazonaws.com/AWSCLIV2.msi" -OutFile "AWSCLIV2.msi"
          Start-Process msiexec.exe -Wait -ArgumentList "/i AWSCLIV2.msi /quiet"
          aws --version

      - name: Configure AWS CLI for Cloudflare R2
        if: success() && steps.check_version.outputs.should_release == 'true'
        run: |
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set region auto
          aws configure set endpoint-url https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com

      - name: Upload to Cloudflare R2
        if: success() && steps.check_version.outputs.should_release == 'true'
        run: |
          # ä¸Šä¼ å®‰è£…åŒ…
          aws s3 cp "build/kadalingo-${{ steps.get_version.outputs.version }}-Setup.exe" "s3://${{ secrets.R2_BUCKET_NAME }}/releases/${{ steps.get_version.outputs.tag_name }}/"
          # ä¸Šä¼ ä¾¿æºç‰ˆ
          aws s3 cp "build/kadalingo ${{ steps.get_version.outputs.version }}.exe" "s3://${{ secrets.R2_BUCKET_NAME }}/releases/${{ steps.get_version.outputs.tag_name }}/"
          # ç”Ÿæˆå¹¶ä¸Šä¼ ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          $versionInfo = @{
            latest_version = "${{ steps.get_version.outputs.version }}"
            release_date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          } | ConvertTo-Json
          $versionInfo | Set-Content -Path version.json
          aws s3 cp version.json "s3://${{ secrets.R2_BUCKET_NAME }}/latest-version.json"
          
      - name: Skip release notification
        if: steps.check_version.outputs.should_release == 'false'
        run: |
          echo "ğŸ”„ ç‰ˆæœ¬æ£€æŸ¥: package.json ä¸­çš„ç‰ˆæœ¬ v${{ steps.check_version.outputs.current_version }} å·²ç»å‘å¸ƒè¿‡ï¼Œè·³è¿‡æœ¬æ¬¡å‘å¸ƒ"
          echo "ğŸ’¡ å¦‚éœ€å¼ºåˆ¶å‘å¸ƒï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è§¦å‘æˆ–åˆ›å»ºæ–°çš„ç‰ˆæœ¬æ ‡ç­¾"
